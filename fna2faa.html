<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DNA to Protein Translator - Web Bio Tools</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-2" id="sidebar-container"></div>
        <div class="col-lg-8 col-md-9 mt-4">
            <h1>DNA to Protein Translator</h1>
            <p>
                Paste nucleotide FASTA entries or raw DNA text below to translate coding sequences
                into amino acids directly in your browser.
            </p>
            <form id="translation-form" class="mb-3">
                <div class="form-group">
                    <label for="fna-input">Nucleotide input</label>
                    <textarea id="fna-input" class="form-control" rows="12" placeholder="Paste FASTA or raw nucleotide sequence"></textarea>
                    <small class="form-text text-muted">
                        Supports multiple FASTA entries or raw text. You can <a href="#" id="load-example">load an example sequence</a> to try it out.
                    </small>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label for="frame-option">Reading frame</label>
                        <select id="frame-option" class="form-control">
                            <option value="all" selected>All frames (+1 to -3)</option>
                            <option value="+1">Frame +1</option>
                            <option value="+2">Frame +2</option>
                            <option value="+3">Frame +3</option>
                            <option value="-1">Frame -1</option>
                            <option value="-2">Frame -2</option>
                            <option value="-3">Frame -3</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4 align-self-end">
                        <div class="form-check mt-2">
                            <input type="checkbox" class="form-check-input" id="stop-option">
                            <label class="form-check-label" for="stop-option">Stop at first stop codon</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Translate</button>
                <a href="index.html" class="btn btn-link">Back to main tools</a>
                <a href="hmm.html" class="btn btn-link">HMM viewer</a>
            </form>
            <p>Ambiguous nucleotides are supported: if all variants code for the same amino acid, that will be the result; otherwise, the result will be <code>X</code>. For example, <code>ATR</code> translates to <code>I</code> because both <code>ATA</code> and <code>ATG</code> code for Isoleucine, while <code>ATN</code> translates to <code>X</code> since <code>ATG</code> codes for Methionine, so not all variants agree. </p>
            <div id="translation-error" class="alert alert-danger" style="display:none"></div>
            <div id="translation-output" class="card" style="display:none">
                <div class="card-body">
                    <h2 class="h5 card-title">Translated sequences</h2>
                    <div id="translation-results" class="translation-results"></div>
                    <div class="d-flex justify-content-end mt-3">
                        <button
                            id="download-fasta"
                            type="button"
                            class="btn btn-outline-secondary"
                            style="display:none"
                        >
                            Download FASTA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function() {
        $('#sidebar-container').load('sidebar.html');
    });
</script>

<script type="module">
import init, { translate_dna_all_frames, translate_dna_frame } from './pkg/web_bio_tools.js';

const exampleFastaEntry = `>GMSC10.90AA.283_000_000\nATGCACGGACACTCCCCGGACGTCACGACCACCACGGTGGACGTGGTCGCCCACGCGGGTTACCGCATCGGGGACCGCGTCCTGCGGGCCGCGAAGGTGACCGTGCTGGATCCTGAGAGCTGA`;

function parseFastaRecords(text) {
    const trimmed = text.trim();
    if (!trimmed) {
        return [];
    }
    const lines = trimmed.split(/\r?\n/);
    const records = [];
    let currentName = null;
    let currentSeq = [];
    let sawHeader = false;

    for (const rawLine of lines) {
        const line = rawLine.trim();
        if (!line) {
            continue;
        }
        if (line.startsWith('>')) {
            if (currentName !== null) {
                records.push({
                    name: currentName,
                    sequence: currentSeq.join(''),
                });
            }
            currentName = line.substring(1).trim() || `Sequence ${records.length + 1}`;
            currentSeq = [];
            sawHeader = true;
        } else {
            currentSeq.push(line.replace(/\s+/g, ''));
        }
    }

    if (currentName !== null) {
        records.push({
            name: currentName,
            sequence: currentSeq.join(''),
        });
    } else if (!sawHeader) {
        const sequence = lines.join('').replace(/\s+/g, '');
        if (sequence.length > 0) {
            records.push({ name: 'Sequence 1', sequence });
        }
    }

    return records;
}

function wrapSequence(sequence, width = 60) {
    if (!sequence) {
        return '';
    }
    const parts = [];
    for (let i = 0; i < sequence.length; i += width) {
        parts.push(sequence.slice(i, i + width));
    }
    return parts.join('\n');
}

function formatFrameLabel(frameNumber) {
    return frameNumber > 0 ? `Frame +${frameNumber}` : `Frame ${frameNumber}`;
}

function buildFastaContent(entries) {
    if (!Array.isArray(entries) || entries.length === 0) {
        return '';
    }
    const fastaBlocks = entries.map((entry) => {
        const header = entry && typeof entry.header === 'string' && entry.header.trim()
            ? entry.header.trim()
            : 'Translated sequence';
        const sequence = entry && typeof entry.sequence === 'string'
            ? entry.sequence
            : '';
        const wrapped = wrapSequence(sequence);
        return `>${header}\n${wrapped}`;
    });
    return fastaBlocks.join('\n\n');
}

function triggerFastaDownload(entries) {
    const content = buildFastaContent(entries);
    if (!content) {
        return;
    }
    const blob = new Blob([`${content}\n`], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const downloadLink = document.createElement('a');
    downloadLink.href = url;
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    downloadLink.download = `translations-${timestamp}.faa`;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(url);
}

function renderTranslation(container, recordName, frameLabel, translation) {
    const pre = document.createElement('pre');
    pre.className = 'translation-sequence';
    const header = `${recordName} | ${frameLabel}`;
    pre.textContent = `>${header}\n${wrapSequence(translation)}`;

    container.appendChild(pre);
}

let lastTranslations = [];

async function bootstrap() {
    await init();
    const form = document.getElementById('translation-form');
    const outputCard = document.getElementById('translation-output');
    const resultsContainer = document.getElementById('translation-results');
    const errorBox = document.getElementById('translation-error');
    const downloadButton = document.getElementById('download-fasta');
    const loadExampleLink = document.getElementById('load-example');

    if (downloadButton) {
        downloadButton.addEventListener('click', () => {
            if (!Array.isArray(lastTranslations) || lastTranslations.length === 0) {
                return;
            }
            triggerFastaDownload(lastTranslations);
        });
    }

    if (loadExampleLink) {
        loadExampleLink.addEventListener('click', (event) => {
            event.preventDefault();
            const input = document.getElementById('fna-input');
            if (input) {
                input.value = exampleFastaEntry;
            }
        });
    }

    form.addEventListener('submit', (event) => {
        event.preventDefault();
        errorBox.style.display = 'none';
        errorBox.textContent = '';
        resultsContainer.innerHTML = '';
        outputCard.style.display = 'none';
        lastTranslations = [];
        if (downloadButton) {
            downloadButton.style.display = 'none';
            downloadButton.disabled = true;
        }

        const inputValue = document.getElementById('fna-input').value;
        const records = parseFastaRecords(inputValue);
        if (records.length === 0) {
            errorBox.textContent = 'Please provide at least one nucleotide sequence to translate.';
            errorBox.style.display = 'block';
            return;
        }

        const frameSelection = document.getElementById('frame-option').value;
        const stopAtFirstStop = document.getElementById('stop-option').checked;

        try {
            const collectedEntries = [];
            for (const [index, record] of records.entries()) {
                const labelBase = record.name || `Sequence ${index + 1}`;
                if (frameSelection === 'all') {
                    const summary = translate_dna_all_frames(record.sequence, stopAtFirstStop);
                    const frames = summary && summary.frames;
                    if (!Array.isArray(frames)) {
                        throw new Error('Unexpected translation summary format returned from translator.');
                    }
                    frames.forEach((entry) => {
                        const frameNumber = Number(entry.frame);
                        const translation =
                            typeof entry.amino_acids === 'string'
                                ? entry.amino_acids
                                : String(entry.amino_acids);
                        const frameLabel = formatFrameLabel(frameNumber);
                        renderTranslation(
                            resultsContainer,
                            labelBase,
                            frameLabel,
                            translation
                        );
                        collectedEntries.push({
                            header: `${labelBase} | ${frameLabel}`,
                            sequence: translation,
                        });
                    });
                } else {
                    const frameNumber = Number.parseInt(frameSelection, 10);
                    if (!Number.isFinite(frameNumber) || frameNumber === 0) {
                        throw new Error(`Invalid frame selection: ${frameSelection}`);
                    }
                    const translation = translate_dna_frame(
                        record.sequence,
                        frameNumber,
                        stopAtFirstStop
                    );
                    const frameLabel = formatFrameLabel(frameNumber);
                    renderTranslation(
                        resultsContainer,
                        labelBase,
                        frameLabel,
                        translation
                    );
                    collectedEntries.push({
                        header: `${labelBase} | ${frameLabel}`,
                        sequence: translation,
                    });
                }
            }
            outputCard.style.display = 'block';
            lastTranslations = collectedEntries;
            if (downloadButton && collectedEntries.length > 0) {
                downloadButton.style.display = 'inline-block';
                downloadButton.disabled = false;
            }
        } catch (error) {
            console.error('Translation failed:', error);
            errorBox.textContent = error instanceof Error ? error.message : String(error);
            errorBox.style.display = 'block';
        }
    });
}

bootstrap().catch((error) => {
    const errorBox = document.getElementById('translation-error');
    if (errorBox) {
        errorBox.textContent = 'Failed to initialize the translation module. Please refresh and try again.';
        errorBox.style.display = 'block';
    }
    console.error('Failed to initialize WebAssembly module', error);
});
</script>
</body>
</html>
