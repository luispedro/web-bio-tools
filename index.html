<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sequence Alignment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <style>
        #result-container pre {
            font-family: monospace;
        }
        .match { color: green; }
        .partial { color: orange; }
        .mismatch { color: red; }
        .gap { color: gray; }
        .btn-group button {
            margin-right: 20px;
        }
    </style>

    <script type="module">
        import init, { smith_waterman_custom, smith_waterman_blosum62, needleman_wunsch_custom, needleman_wunsch_blosum62 } from './pkg/web_bio_tools.js';

        async function run() {
            await init();

            function parseFasta(text, defaultName) {
                const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');
                if (lines.length === 0) {
                    return { name: defaultName, sequence: '' };
                }
                if (lines[0].startsWith('>')) {
                    const name = lines[0].substring(1).trim() || defaultName;
                    const seq = lines.slice(1).join('').replace(/\s+/g, '');
                    return { name, sequence: seq };
                } else {
                    const seq = lines.join('').replace(/\s+/g, '');
                    return { name: defaultName, sequence: seq };
                }
            }

            window.alignSequences = (algorithm) => {
                const parsed1 = parseFasta(document.getElementById('seq1').value, 'sequence1');
                const parsed2 = parseFasta(document.getElementById('seq2').value, 'sequence2');
                const warningEl = document.getElementById('input-warning');
                if (parsed1.sequence === '' || parsed2.sequence === '') {
                    warningEl.textContent = 'Please enter sequences in both input fields before alignment. You can also load the example sequences.';
                    warningEl.style.display = 'block';
                    return;
                }
                warningEl.style.display = 'none';
                const gapOpen = parseInt(document.getElementById('gap-open').value, 10);
                const gapExtend = parseInt(document.getElementById('gap-extend').value, 10);
                const weightOption = document.getElementById('weight-option').value;
                let result;
                if (algorithm === 'nw') {
                    if (weightOption === 'blosum62') {
                        result = needleman_wunsch_blosum62(parsed1.sequence, parsed2.sequence, gapOpen, gapExtend);
                    } else {
                        const matchScore = parseInt(document.getElementById('match-score').value, 10);
                        const mismatchPenalty = parseInt(document.getElementById('mismatch-penalty').value, 10);
                        result = needleman_wunsch_custom(parsed1.sequence, parsed2.sequence, matchScore, mismatchPenalty, gapOpen, gapExtend);
                    }
                } else {
                    if (weightOption === 'blosum62') {
                        result = smith_waterman_blosum62(parsed1.sequence, parsed2.sequence, gapOpen, gapExtend);
                    } else {
                        const matchScore = parseInt(document.getElementById('match-score').value, 10);
                        const mismatchPenalty = parseInt(document.getElementById('mismatch-penalty').value, 10);
                        result = smith_waterman_custom(parsed1.sequence, parsed2.sequence, matchScore, mismatchPenalty, gapOpen, gapExtend);
                    }
                }
                document.getElementById('result-container').style.visibility = 'visible';

                const seq1 = result.aligned_seq1;
                const seq2 = result.aligned_seq2;
                const markup = result.alignment_markup;
                let final = '';
                let html1 = '';
                let htmlm = '';
                let html2 = '';
                let m = '';
                for (let i = 0; i < seq1.length; i++) {
                    const c1 = seq1[i];
                    const c2 = seq2[i];
                    const mark = markup[i];
                    let cls = 'match';
                    if (mark === ' ') {
                        cls = 'gap';
                        m = ' ';
                    } else if (mark === ':') {
                        cls = 'partial';
                        m = ':';
                    } else if (mark === '.') {
                        cls = 'mismatch';
                        m = 'X';
                    } else {
                        m = '|';
                    }
                    html1 += `<span class="${cls}">${c1}</span>`;
                    html2 += `<span class="${cls}">${c2}</span>`;
                    htmlm += m;
                    if (i % 80 === 79) {
                        final += html1 + '\n';
                        final += htmlm + '\n';
                        final += html2 + '\n';
                        final += '\n\n';
                        html1 = '';
                        htmlm = '';
                        html2 = '';
                    }
                }

                if (html1.length > 0) {
                    final += html1 + '\n';
                    final += htmlm + '\n';
                    final += html2 + '\n';
                }

                document.getElementById('result').innerHTML = final;

                document.getElementById('alignment-length').textContent = result.aligned_length;
                document.getElementById('alignment-score').textContent = (100 * result.aligned_identity).toFixed(2) + '%';
            };

        }

        run();
    </script>
    <script>
        $(function() {
            const seq_example_similar_1 = ">SHD1_0000\n" +
                "MKAGHLKDIDKPSEPFEVIGKIIPRYENENWTFTELLYEAPYLKSYQDEEDEEDEEADCLEYIDNTDKIIYLYYQDDKCVGKVKLRKNWNRYAYIEDIAVCKDFRGQGIGSALINISIEWAKHKNLHGLMLETQDNNLIACKFYHNCGFKIGSVDTMLYANFENNFEKAVFWYLRF";
            const seq_example_similar_2 = ">gb|AAB53445.1|+|SAT-4 [Campylobacter coli]\n" +
                "MITEMKAEHLKDIDKPSEPFEVIGKIIPRYENENWTFTELLYEAPYLKSYQDEEDEEDEEADCLEYIDNTDKIIYLYYQDDKCVGKVKLRKNWNRYAYIEDIAVCKDFRGQGIGSALINISIEWAKHKNLHGLMLETQDNNLIACKFYHNCGFKIGSVDTMLYANFENNFEKAVFWYLRF";

            const example_intermediate_1 = ">dldHA2X_1_AL939117_partial\n" +
                "MTFSSTSSAPPPSPLLPATRITVYGCGRDEAALFRRTAPRFGVEATLTEAAVSEENAEMAAGNQCISIDHKTPVTPATLRALHRAGVTYISTRSIGYNHIDVTYAAGVGISVENVTYSPAGVADYTLMLMLMAVRNAKSTVRRAELHDYRLNEIRGKELRDLTVGVIGTGRIGAAVVDRLRGFGSRVLAYGKRPTIAADYVSLDELLRSSDIVSLHVPLTPDTHHLLDQSRIRRMKSGAFVINTGRGPLIDTEALVPALESGRLSGAALDVIEGEEGIFYADCRNRTIESTWLPRLQKMPNVLISPHTAYYTDHALMDTVENSIINCLNFGSRKQHGVGQVGQVEGRHRIRGLFRRTRRFRQVRPGGRTQPRHREVPAVLRGDHEGRRLETLRRARPGLGERRLPS";

            const example_intermediate_2 = ">gnl|BL_ORD_ID|759|hsp_num:0\n" +
                "MSYRDLGLIDSEVIAERRVRALDDSSPSAVPTTGVRVFGCGHDEAVLFREMGTRLGITPSITEEAISETNAELARGNRCISVSHKTQIDNSTLLALSRVGVEYISTRSVGYNHIDVEFAASIGISVGNVDYSPDSVGDYTLMLMLMTVRHAKSIVRRADTHDYRLNDTRGRELRDLTVGVIGTGRIGTAVIDRLQGFGCRVLAHDSGPHASADYVPLDELLRQSDIVTLHTPLTADTHHLLDRQRIDQMKHGAYIVNTGRGPLLDTEALLSALESGRLGGAALDVVEGEEGIFYADCRNRLIENKALVRLQRLPNVLISPHSAYYTDHALNDTVENSLVNCLNFESGRTA";

            const seq_example_different_1 = ">ERMA_STAAU\n" +
                "MNQKNPKDTQNFITSKKHVKEILNHTNISKQDNVIEIGSGKGHFTKELVKMSRSVTAIEIDGGLCQVTKEAVNPSENIKVIQTDILKFSFPKHINYKIYGNIPYNISTDIVKRITFESQAKYSYLIVEKGFAKRLQNLQRALGLLLMVEMDIKMLKKVPPLYFHPKPSVDSVLIVLERHQPLISKKDYKKYRSFVYKWVNREYRVLFTKNQFRQALKHANVTNINKLSKEQFLSIFNSYKLFH";
            const seq_example_different_2 = ">ERMA_AERER\n" +
                "MAGPQDRPRGRGPSSGRPQRPVGGRSQRDRDRRVLGQNFLRDPATIRRIADAADVDPDGLVVEAGPGEGLLTRELARRAGRVRTYELDQRLARRLSTDLAQETSIEVVHADFLTAPHPEEPFQFVGAIPYGITSAIVDWCLTAPTLTSATLVTQQEFARKRTGDYGRWTALTVTTWPTFEWQYVAKVDRTLFTPVPRVHSAIMRLRRRPQPLLRDAAARSRFADMVEIGFVGKGGSLYRSLTREWPRSKVDSAFARADVHHDEIVAFVHPDQWITLFQLLDGSRGGAARGPGDQRGRRGRPGGGPRPDGRAGGGPRRDAGGRRTGDGRGGRPRPPRGGQA";

            $('#load-example-similar').on('click', function(e) {
                e.preventDefault();
                $('#seq1').val(seq_example_similar_1);
                $('#seq2').val(seq_example_similar_2);
            });
            $('#load-example-intermediate').on('click', function(e) {
                e.preventDefault();
                $('#seq1').val(example_intermediate_1);
                $('#seq2').val(example_intermediate_2);
            });
            $('#load-example-different').on('click', function(e) {
                e.preventDefault();
                $('#seq1').val(seq_example_different_1);
                $('#seq2').val(seq_example_different_2);
            });
            $('#toggle-advanced').on('click', function(e) {
                e.preventDefault();
                $('#advanced-params').toggle();
                $(this).text(function(_, txt) {
                    return txt === 'Show advanced parameters' ? 'Hide advanced parameters' : 'Show advanced parameters';
                });
            });
            $('#weight-option').on('change', function() {
                if (this.value === 'uniform') {
                    $('#uniform-params').addClass('show');
                } else {
                    $('#uniform-params').removeClass('show');
                }
            }).trigger('change');
        });
    </script>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2">
            <nav id="leftbar">
                <div>
                    <h6>Links</h6>
                    <ul>
                        <li><a href="https://github.com/luispedro/web-bio-tools">GitHub repository</a></li>
                        <li><a href="https://luispedro.org">Luis Pedro Coelho's homepage</a></li>
                        <li><a href="https://big-data-biology.org/">Big Data Biology Lab</a></li>
                    </ul>
                    </div>
                </nav>
            </div>
            <div class="col">
                <h1>Web Bio Tools</h1>
                <div class="alert alert-warning text-center" role="alert">
                    This site is experimental and untested.
                </div>
                <h2>Sequence Alignment</h2>
                <textarea id="seq1" placeholder="Enter first sequence (FASTA or raw)" rows=20 cols=40></textarea>
                <textarea id="seq2" placeholder="Enter second sequence (FASTA or raw)" rows=20 cols=40></textarea>
                <p>
                    Load example sequences:
                    <a href="#" id="load-example-similar">very similar sequences</a> |
                    <a href="#" id="load-example-intermediate">somewhat divergent sequences</a> |
                    <a href="#" id="load-example-different">very different sequences</a>
                </p>
                <p><a href="#" id="toggle-advanced">Show advanced parameters</a></p>
                <div id="advanced-params" style="display:none;">
                    <label>Scoring matrix:
                        <select id="weight-option">
                            <option value="uniform">Uniform</option>
                            <option value="blosum62" selected>BLOSUM62</option>
                        </select>
                    </label><br>
                    <div id="uniform-params">
                        <label>Match score: <input type="number" id="match-score" value="2"></label><br>
                        <label>Mismatch penalty: <input type="number" id="mismatch-penalty" value="-1"></label><br>
                    </div>
                    <label>Gap open penalty: <input type="number" id="gap-open" value="-10"></label><br>
                    <label>Gap extend penalty: <input type="number" id="gap-extend" value="-1"></label>
                </div>
                <div id="input-warning" class="alert alert-warning mt-2" style="display:none"></div>
                <div class="btn-group" role="group">
                    <button class="btn btn-primary" onclick="alignSequences('sw')">Local Alignment</button>
                    <button class="btn btn-primary" onclick="alignSequences('nw')">Global Alignment</button>
                </div>
                <div id="result-container"
                     style="visibility: hidden;">
                    <h3>Alignment Result:</h3>
                    <p>Alignment length: <span id="alignment-length"></span> (<span id="alignment-score"></span> identity)</p>
                    <pre id="result"></pre>
                </div>

                <p>
                    This site provides simple bioinformatics tools compiled to WebAssembly
                    with Rust. It can perform local or global sequence alignment
                    directly in your browser.
                </p>
                <p>
                    Source code available on <a href="https://github.com/luispedro/web-bio-tools">GitHub</a>.<br>
                    Author: <a href="https://luispedro.org">Luis Pedro Coelho</a>
                </p>
            </div>
        </div>
    </div>
</body>
</html>
