<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sequence Alignment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <style>
        #result-container pre {
            font-family: monospace;
        }
        .match { color: green; }
        .mismatch { color: red; }
        .gap { color: gray; }
    </style>

    <script type="module">
        import init, { smith_waterman_custom } from './pkg/web_bio_tools.js';

        async function run() {
            await init();

            function parseFasta(text, defaultName) {
                const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');
                if (lines.length === 0) {
                    return { name: defaultName, sequence: '' };
                }
                if (lines[0].startsWith('>')) {
                    const name = lines[0].substring(1).trim() || defaultName;
                    const seq = lines.slice(1).join('').replace(/\s+/g, '');
                    return { name, sequence: seq };
                } else {
                    const seq = lines.join('').replace(/\s+/g, '');
                    return { name: defaultName, sequence: seq };
                }
            }

            window.alignSequences = () => {
                const parsed1 = parseFasta(document.getElementById('seq1').value, 'sequence1');
                const parsed2 = parseFasta(document.getElementById('seq2').value, 'sequence2');
                const matchScore = parseInt(document.getElementById('match-score').value, 10);
                const mismatchPenalty = parseInt(document.getElementById('mismatch-penalty').value, 10);
                const gapPenalty = parseInt(document.getElementById('gap-penalty').value, 10);
                const result = smith_waterman_custom(parsed1.sequence, parsed2.sequence, matchScore, mismatchPenalty, gapPenalty);
                document.getElementById('result-container').style.visibility = 'visible';

                const seq1 = result.aligned_seq1;
                const seq2 = result.aligned_seq2;
                let html1 = '';
                let html2 = '';
                for (let i = 0; i < seq1.length; i++) {
                    const c1 = seq1[i];
                    const c2 = seq2[i];
                    let cls = 'match';
                    if (c1 === '-' || c2 === '-') {
                        cls = 'gap';
                    } else if (c1 !== c2) {
                        cls = 'mismatch';
                    }
                    html1 += `<span class="${cls}">${c1}</span>`;
                    html2 += `<span class="${cls}">${c2}</span>`;
                }

                document.getElementById('result').innerHTML =
                    '&gt;' + parsed1.name + '\n' +
                    html1 + '\n' +
                    '&gt;' + parsed2.name + '\n' +
                    html2;

                document.getElementById('alignment-length').textContent = result.aligned_length;
                document.getElementById('alignment-score').textContent = (100 * result.aligned_identity).toFixed(2) + '%';
            };

        }

        run();
    </script>
    <script>
        $(function() {
            $('#load-example').on('click', function(e) {
                e.preventDefault();
                $('#seq1').val('>example1\nATGCGTACGTAGCTAGCTAGCTAGCTATAGCTAGCTGATCGTAGCA');
                $('#seq2').val('>example2\nATCCGTACGTAGCTAGGTAGCTAGTTGTAGCTAGCTGATCGTAGCCA');
            });
            $('#toggle-advanced').on('click', function(e) {
                e.preventDefault();
                $('#advanced-params').toggle();
                $(this).text(function(_, txt) {
                    return txt === 'Show advanced parameters' ? 'Hide advanced parameters' : 'Show advanced parameters';
                });
            });
        });
    </script>

    <p>
        This site provides simple bioinformatics tools compiled to WebAssembly
        with Rust. The current tool performs Smith-Waterman local sequence
        alignment directly in your browser.
    </p>
    <p>
        Source code available on <a href="https://github.com/luispedro/web-bio-tools">GitHub</a>.<br>
        Author: <a href="https://luispedro.org">Luis Pedro Coelho</a>
    </p>
    <h2>Sequence Alignment using Smith-Waterman</h2>
    <textarea id="seq1" placeholder="Enter first sequence (FASTA or raw)" rows=24 cols=48></textarea>
    <textarea id="seq2" placeholder="Enter second sequence (FASTA or raw)" rows=24 cols=48></textarea>
    <p><a href="#" id="load-example">Load example sequences</a></p>
    <p><a href="#" id="toggle-advanced">Show advanced parameters</a></p>
    <div id="advanced-params" style="display:none;">
        <label>Match score: <input type="number" id="match-score" value="2"></label><br>
        <label>Mismatch penalty: <input type="number" id="mismatch-penalty" value="-1"></label><br>
        <label>Gap penalty: <input type="number" id="gap-penalty" value="-1"></label>
    </div>
    <button onclick="alignSequences()">Align</button>
    <div id="result-container"
         style="visibility: hidden;">
        <h3>Alignment Result:</h3>
        <p>Alignment length: <span id="alignment-length"></span> (<span id="alignment-score"></span> identity)</p>
        <pre id="result"></pre>
    </div>
</body>
</html>
